<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="description" content="Beauty Recovery Home">
    <title>Beauty Recovery Home</title>
    <meta property="og:title" content="Dashboard – Beauty Recovery Home" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://lwilliams002.github.io/Oli-CRM" />
    <meta property="og:image" content="https://lwilliams002.github.io/Oli-CRM/assets/images/download.png" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Dashboard – Beauty Recovery Home" />
    <meta name="twitter:description" content="Beauty Recovery Home" />
    <meta name="twitter:image" content="https://lwilliams002.github.io/Oli-CRM" />
    <!-- Favicon icon -->
    <link rel="icon" type="image/png" href="assets/images/favicon-32x32.png">
    <!-- Base Styling  -->
    <link rel="stylesheet" href="assets/main/css/fonts.css">
    <link rel="stylesheet" href="assets/main/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
    <script>
        // Initialize Supabase client
        const SUPABASE_URL = 'https://aqkkmgjlcxdbuhwzjeou.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFxa2ttZ2psY3hkYnVod3pqZW91Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU3MjYxNjAsImV4cCI6MjA2MTMwMjE2MH0.kVMtxC6XgrGA8BFwbruCOY5KYv84Phb1M6gi2brojtY';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    </script>

</head>

<body>
    <div id="main-wrapper" class="show">

        <!-- start section sidebar -->
        <aside class="left-panel nicescroll-box">
            <nav class="navigation">
                <ul class="list-unstyled main-menu">
                    <li class="has-submenu active">
                        <a href="index.html">
                            <i class="fas fa-th-large"></i>
                            <span class="nav-label">Dashboard</span>
                        </a>
                    </li>

                    <li class="has-submenu">
                        <a href="javascript:void()" class="has-arrow mm-collapsed">
                            <i class="fas fa-users"></i>
                            <span class="nav-label">Patients</span>
                        </a>
                        <ul class="list-unstyled mm-collapse">
                            <li><a href="new-patient.html">New Patient</a></li>
                            <li><a href="all-patients.html">All Patients</a></li>
                        </ul>
                    </li>
                    <li class="has-submenu">
                        <a href="new-appointment.html">
                            <i class="fas fa-calendar-plus"></i>
                            <span class="nav-label">Appointment</span>
                        </a>
                    </li>


                </ul>
            </nav>

        </aside>
        <!-- End section sidebar -->


        <!-- start logo components -->
        <div class="nav-header">
            <div class="brand-logo">
                <a href="index.html"> <img class="logo-tabib" src="assets/images/download.png" alt=""></a>
                <a href="index.html"><img class="brand-title" src="assets/images/logo.png" alt=""></a>
            </div>
        </div>
        <!-- End logo components -->


        <!-- start section header -->
        <div class="header">
            <header class="top-head container-fluid">
                <div class="nav-control">
                    <div class="hamburger">
                        <span class="line"></span><span class="line"></span><span class="line"></span>
                    </div>
                </div>
                <div class="header-right">
                    <div class="fullscreen notification_dropdown widget-5">
                        <div class="full">
                            <a class="text-dark" href="#!" onclick="javascript:toggleFullScreen()">
                                <i class="fas fa-expand"></i>
                            </a>
                        </div>
                    </div>

                    <div class="my-account-wrapper widget-7">
                        <div class="account-wrapper">
                            <div class="account-control">
                                <a class="login header-profile" href="#" title="Sign in">
                                    <div class="header-info">
                                        <span id="user-email">Dr Roberts</span>
                                        <small>Admin</small>
                                    </div>

                                </a>
                                <div class="account-dropdown-form dropdown-container">
                                    <div class="form-content">
                                        <a href="page-login.html">
                                            <i class="fas fa-sign-in-alt"></i>
                                            <span class="ml-2">Logout </span>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </header>
        </div>
        <!-- End section header -->

        <!-- start section content -->
        <div class="content-body">
            <div class="warper container-fluid">
              <div class="patient-detail">
                <div class="card mb-4">
                  <div class="card-header d-flex align-items-center">
                    <img id="patient-photo" class="rounded-circle img-fluid me-3" width="350" height="350" alt="Profile Photo">
                    <h4 id="patient-name" class="mb-0">Loading...</h4>
                  </div>
                  <div class="card-body">
                    <div class="row">
                      <!-- Left column: Personal Info -->
                      <div class="col-md-6">
                        <h5>Personal Information</h5>
                        <dl class="row">
                          <dt class="col-sm-4">First Name</dt><dd class="col-sm-8"><span id="patient-first"></span></dd>
                          <dt class="col-sm-4">Last Name</dt><dd class="col-sm-8"><span id="patient-last"></span></dd>
                          <dt class="col-sm-4">Email</dt><dd class="col-sm-8"><span id="patient-email"></span></dd>
                          <dt class="col-sm-4">Phone</dt><dd class="col-sm-8"><span id="patient-phone"></span></dd>
                          <dt class="col-sm-4">Birthday</dt><dd class="col-sm-8"><span id="patient-birthday"></span></dd>
                          <dt class="col-sm-4">Marital Status</dt><dd class="col-sm-8"><span id="patient-marital"></span></dd>
                          <dt class="col-sm-4">Sex</dt><dd class="col-sm-8"><span id="patient-sex"></span></dd>
                        </dl>
                      </div>
                      <!-- Right column: Medical & Address -->
                      <div class="col-md-6">
                        <h5>Medical & Address</h5>
                        <dl class="row">
                          <dt class="col-sm-4">Blood Group</dt><dd class="col-sm-8"><span id="patient-blood"></span></dd>
                          <dt class="col-sm-4">Weight</dt><dd class="col-sm-8"><span id="patient-weight"></span></dd>
                          <dt class="col-sm-4">Height</dt><dd class="col-sm-8"><span id="patient-height"></span></dd>
                          <dt class="col-sm-4">Address</dt><dd class="col-sm-8"><span id="patient-address"></span></dd>
                          <dt class="col-sm-4">History</dt><dd class="col-sm-8"><span id="patient-history"></span></dd>
                        </dl>
                      </div>
                    </div>
                  </div>
                </div>
                  <!-- Consent Form -->
                  <div class="row">
                      <div class="col-xl-12">
                          <div class="form-group mt-2">
                              <button id="btn-sign-consent" type="button" class="btn btn-outline-primary me-2">
                                  Open Consent Form
                              </button>
                              <button id="btn-sign-terms" type="button" class="btn btn-outline-primary">
                                  Open Terms & Conditions
                              </button>
                          </div>
                      </div>
                  </div>
                  <div class="row">
                <!-- Documents card -->
                <div class="card">
                  <div class="card-header">
                    <h5>Documents</h5>
                    <button id="add-document-btn" class="btn btn-sm btn-primary ms-2">Add Document</button>
                  </div>
                  <div class="card-body">
                    <input type="file" id="document-input" style="display:none;" accept=".pdf,.doc,.docx,.png,.jpg,.jpeg,.gif" multiple />
                    <ul id="documents-list" class="list-unstyled mb-0"></ul>
                  </div>
                </div>
                <!-- Change Log card -->
                <div class="card mt-4">
                  <div class="card-header d-flex justify-content-between align-items-center">
                    <h5>Patient Change Log</h5>
                    <button id="add-log-btn" class="btn btn-sm btn-primary">Add Entry</button>
                  </div>
                  <div class="card-body">
                    <!-- New log form (hidden until "Add Entry" clicked) -->
                    <form id="new-log-form" class="mb-3" style="display:none;">
                      <div class="row">
                        <div class="col-md-4 mb-2">
                          <label for="log-bp" class="form-label">Blood Pressure</label>
                          <input type="text" id="log-bp" class="form-control" placeholder="e.g. 120/80">
                        </div>
                        <div class="col-md-4 mb-2">
                          <label for="log-oxygen" class="form-label">Oxygen Level (%)</label>
                          <input type="number" id="log-oxygen" class="form-control" placeholder="e.g. 98">
                        </div>
                        <div class="col-md-4 mb-2">
                          <label for="log-temp" class="form-label">Temperature (°C)</label>
                          <input type="number" step="0.1" id="log-temp" class="form-control" placeholder="e.g. 36.6">
                        </div>
                      </div>
                      <div class="mb-2">
                        <label for="log-entry" class="form-label">Notes</label>
                        <textarea id="log-entry" class="form-control" rows="2" placeholder="Additional notes"></textarea>
                      </div>
                      <button type="submit" class="btn btn-sm btn-success">Save Log</button>
                      <button type="button" id="cancel-log-btn" class="btn btn-sm btn-secondary">Cancel</button>
                    </form>
                    <!-- Existing log entries -->
                    <ul id="log-list" class="list-group"></ul>
                  </div>
                </div>
              </div>
            </div>
        </div>
        <!-- End section content -->


    </div>

    <!-- JQuery v3.5.1 -->
    <script src="assets/plugins/jquery/jquery.min.js"></script>

    <!-- popper js -->
    <script src="assets/plugins/popper/popper.min.js"></script>

    <!-- Bootstrap -->
    <script src="assets/plugins/bootstrap/js/bootstrap.js"></script>

    <!-- Moment -->
    <script src="assets/plugins/moment/moment.min.js"></script>

    <!-- Date Range Picker -->
    <script src="assets/plugins/daterangepicker/daterangepicker.min.js"></script>

    <!-- Main Custom JQuery -->
    <script src="assets/js/toggleFullScreen.js"></script>
    <script src="assets/js/main.js"></script>
    <script src="assets/js/option-themes.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', async () => {
        // Parse ?id= from URL
        const params = new URLSearchParams(window.location.search);
        const id = params.get('id');

        if (!id) {
          document.getElementById('patient-name').textContent = 'No patient ID';
          return;
        }
          document.getElementById('btn-sign-consent').addEventListener('click', () => {
              window.open(`consent.html?id=${id}`, '_blank');
          });
          document.getElementById('btn-sign-terms').addEventListener('click', () => {
              window.open(`terms.html?id=${id}`, '_blank');
          });

        try {
          // Fetch the single patient
          const { data: patient, error: pErr } = await supabaseClient
            .from('patients')
            .select('*')
            .eq('id', id)
            .single();
          if (pErr || !patient) {
            document.getElementById('patient-name').textContent = 'Patient not found';
            console.error(pErr);
            return;
          }
          // Populate fields
          document.getElementById('patient-name').textContent      = `${patient.first_name} ${patient.last_name}`;
          document.getElementById('patient-first').textContent     = patient.first_name || '—';
          document.getElementById('patient-last').textContent      = patient.last_name || '—';
          document.getElementById('patient-email').textContent     = patient.email || '—';
          document.getElementById('patient-phone').textContent     = patient.phone || '—';
          document.getElementById('patient-birthday').textContent  = patient.birthday || '—';
          document.getElementById('patient-marital').textContent   = patient.marital_status || '—';
          document.getElementById('patient-sex').textContent       = patient.sex || '—';
          document.getElementById('patient-blood').textContent     = patient.blood_group || '—';
          document.getElementById('patient-weight').textContent    = patient.weight || '—';
          document.getElementById('patient-height').textContent    = patient.height || '—';
          document.getElementById('patient-address').textContent   = patient.address || '—';
          document.getElementById('patient-history').textContent   = patient.history || '—';

          // Display profile photo
          const photoEl = document.getElementById('patient-photo');
          if (patient.profile_url) {
            console.log('Profile URL path:', patient.profile_url);
            const { data: photoUrlData, error: photoUrlErr } = supabaseClient
              .storage.from('patient-photos')
              .getPublicUrl(patient.profile_url);
            console.log('getPublicUrl returned:', photoUrlData, photoUrlErr);
            if (!photoUrlErr && photoUrlData.publicUrl) {
              photoEl.src = photoUrlData.publicUrl;
              console.log('Photo element src set to:', photoUrlData.publicUrl);
            } else {
              console.error('Failed to set photo src:', photoUrlErr);
            }
          } else {
            console.warn('No profile_url found for patient:', patient);
          }

          // Fetch document metadata
          const { data: docs, error: dErr } = await supabaseClient
            .from('patient_documents')
            .select('file_url')
            .eq('patient_id', id);
          if (dErr) {
            console.error(dErr);
            return;
          }
          const list = document.getElementById('documents-list');
          docs.forEach(doc => {
            // Get the public URL for the file
            const { data: urlData, error: urlError } = supabaseClient
              .storage
              .from('patient-documents')
              .getPublicUrl(doc.file_url);
            if (urlError) {
              console.error('Error fetching public URL for', doc.file_url, urlError);
              return;
            }
            const publicUrl = urlData.publicUrl;
            // Enhanced: Show inline preview for image files
            const fileName = doc.file_url.split('/').pop();
            const extension = fileName.split('.').pop().toLowerCase();
            let contentHtml;
            if (['png', 'jpg', 'jpeg', 'gif'].includes(extension)) {
              contentHtml = `
                <img src="${publicUrl}" alt="${fileName}" style="max-width:150px; display:block; margin-bottom:5px;">
                <a href="${publicUrl}" target="_blank">${fileName}</a>
              `;
            } else {
              contentHtml = `<a href="${publicUrl}" target="_blank">${fileName}</a>`;
            }
            const li = document.createElement('li');
            li.innerHTML = contentHtml;
            list.appendChild(li);
          });
          // Add Document button logic
          const addDocBtn = document.getElementById('add-document-btn');
          const docInput = document.getElementById('document-input');
          addDocBtn.addEventListener('click', () => docInput.click());
          docInput.addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            for (let file of files) {
              const originalName = file.name.normalize('NFKD');
              const safeName = originalName
                .replace(/[\u0300-\u036f]/g, '')      // strip diacritics
                .replace(/\s+/g, '_')                // spaces to underscores
                .replace(/[^a-zA-Z0-9_.-]/g, '');     // remove invalid chars
              const filePath = `documents/${Date.now()}_${safeName}`;
              // Upload to storage
              const { data: uploadData, error: uploadError } = await supabaseClient
                .storage.from('patient-documents').upload(filePath, file);
              if (uploadError) {
                console.error('Document upload error:', uploadError);
                continue;
              }
              const storedPath = uploadData.path ?? uploadData.Key;
              // Record in database
              const fileType = safeName.split('.').pop().toLowerCase();
              const { error: insertError } = await supabaseClient
                .from('patient_documents')
                .insert([{ patient_id: id, file_url: storedPath, file_type: fileType }]);
              if (insertError) {
                console.error('Document insert error:', insertError);
              }
            }
            // Refresh to show new documents
            window.location.reload();
          });
        } catch (err) {
          console.error('Unexpected error:', err);
        }
      });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const { data: { user } } = await supabaseClient.auth.getUser();
            if (user && user.email) {
                document.getElementById('user-email').textContent = user.email;
            }
        });
        // Enhanced logout handler (attach to logout link if present)
        document.addEventListener('DOMContentLoaded', () => {
            const logoutLink = document.getElementById('logout-link');
            if (logoutLink) {
                logoutLink.addEventListener('click', async (e) => {
                    e.preventDefault();
                    await supabaseClient.auth.signOut();
                    // Clear stored session data
                    localStorage.clear();
                    sessionStorage.clear();
                    // Replace history entry and redirect to login
                    window.location.replace('page-login.html');
                });
            }
        });
    </script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const id = new URLSearchParams(window.location.search).get('id');
  const logList = document.getElementById('log-list');
  const newLogForm = document.getElementById('new-log-form');
  const addLogBtn = document.getElementById('add-log-btn');
  const cancelLogBtn = document.getElementById('cancel-log-btn');
  const logEntry = document.getElementById('log-entry');


  // Fetch and render logs
  async function loadLogs() {
    logList.innerHTML = '';
    const { data: logs, error } = await supabaseClient
      .from('patient_logs')
      .select('*')
      .eq('patient_id', id)
      .order('created_at', { ascending: false });
    if (error) return console.error(error);
    logs.forEach(log => {
      const li = document.createElement('li');
      li.className = 'list-group-item';
      li.innerHTML = `
        <small class="text-muted">${new Date(log.created_at).toLocaleString()}</small>
        <ul class="list-unstyled mb-1 mt-1">
          <li><strong>Blood Pressure:</strong> ${log.blood_pressure || '—'}</li>
          <li><strong>Oxygen Level:</strong> ${log.oxygen_level != null ? log.oxygen_level + '%' : '—'}</li>
          <li><strong>Temperature:</strong> ${log.temperature != null ? log.temperature + '°C' : '—'}</li>
        </ul>
        <div>${log.entry || ''}</div>
      `;
      logList.appendChild(li);
    });
  }

  // Show/hide form
  addLogBtn.addEventListener('click', () => {
    newLogForm.style.display = 'block';
    addLogBtn.disabled = true;
  });
  cancelLogBtn.addEventListener('click', () => {
    newLogForm.style.display = 'none';
    addLogBtn.disabled = false;
    logEntry.value = '';
  });

  // Handle new log submission
  newLogForm.addEventListener('submit', async e => {
    e.preventDefault();
    const bp = document.getElementById('log-bp').value.trim();
    const oxygen = parseFloat(document.getElementById('log-oxygen').value);
    const temp = parseFloat(document.getElementById('log-temp').value);
    const notes = document.getElementById('log-entry').value.trim();
    // Optionally, you may validate at least one field is filled; for now, allow empty notes
    const { error } = await supabaseClient
      .from('patient_logs')
      .insert([{
        patient_id: id,
        blood_pressure: bp,
        oxygen_level: oxygen,
        temperature: temp,
        entry: notes
      }]);
    if (error) return console.error(error);
    document.getElementById('log-bp').value = '';
    document.getElementById('log-oxygen').value = '';
    document.getElementById('log-temp').value = '';
    document.getElementById('log-entry').value = '';
    newLogForm.style.display = 'none';
    addLogBtn.disabled = false;
    loadLogs();
  });

  // Initial load
  loadLogs();
});
</script>
</body>

</html>