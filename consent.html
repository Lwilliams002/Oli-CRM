<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Tabib Apps web | Admin Dashboard Template</title>
    <!-- Favicon icon -->
    <link rel="icon" type="image/png" href="assets/images/favicon-32x32.png">
    <!-- Base Styling  -->
    <link rel="stylesheet" href="assets/main/css/fonts.css">
    <link rel="stylesheet" href="assets/main/css/style.css">

    <style>
      .sig-box {
        width: 100%;
        max-width: 600px;
        margin: 1rem auto;
      }
      .sig-box canvas {
        width: 100% !important;
        height: 200px !important;
        border: 1px solid #ced4da;
        border-radius: 4px;
      }
    </style>

    <!-- Signature Pad -->
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <!-- html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Supabase UMD -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
</head>

<body>
    <div id="main-wrapper" class="show">


        <!-- start section sidebar -->
        <aside class="left-panel nicescroll-box">
            <nav class="navigation">
                <ul class="list-unstyled main-menu">
                    <li class="has-submenu active">
                        <a href="index.html">
                            <i class="fas fa-th-large"></i>
                            <span class="nav-label">Dashboard</span>
                        </a>
                    </li>

                    <li class="has-submenu">
                        <a href="javascript:void()" class="has-arrow mm-collapsed">
                            <i class="fas fa-users"></i>
                            <span class="nav-label">Patients</span>
                        </a>
                        <ul class="list-unstyled mm-collapse">
                            <li><a href="new-patient.html">New Patient</a></li>
                            <li><a href="all-patients.html">All Patients</a></li>
                        </ul>
                    </li>
                    <li class="has-submenu">
                        <a href="new-appointment.html">
                            <i class="fas fa-calendar-plus"></i>
                            <span class="nav-label">Appointment</span>
                        </a>
                    </li>


                </ul>
            </nav>

        </aside>
        <!-- End section sidebar -->


        <!-- start logo components -->
        <div class="nav-header">
            <div class="brand-logo">
                <a href="index.html"> <img class="logo-tabib" src="assets/images/download.png" alt=""></a>
                <a href="index.html"><img class="brand-title" src="assets/images/logo.png" alt=""></a>
            </div>
        </div>
        <!-- End logo components -->


        <!-- start section header -->
        <div class="header">
            <header class="top-head container-fluid">
                <div class="nav-control">
                    <div class="hamburger">
                        <span class="line"></span><span class="line"></span><span class="line"></span>
                    </div>
                </div>
                <div class="header-right">
                    <div class="fullscreen notification_dropdown widget-5">
                        <div class="full">
                            <a class="text-dark" href="#!" onclick="javascript:toggleFullScreen()">
                                <i class="fas fa-expand"></i>
                            </a>
                        </div>
                    </div>

                    <div class="my-account-wrapper widget-7">
                        <div class="account-wrapper">
                            <div class="account-control">
                                <a class="login header-profile" href="#" title="Sign in">
                                    <div class="header-info">
                                        <span id="user-email">Dr Roberts</span>
                                        <small>Admin</small>
                                    </div>

                                </a>
                                <div class="account-dropdown-form dropdown-container">
                                    <div class="form-content">
                                        <a href="page-login.html">
                                            <i class="fas fa-sign-in-alt"></i>
                                            <span class="ml-2">Logout </span>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </header>
        </div>
        <!-- End section header -->


        <!-- start section content -->
        <div class="content-body">
            <div class="warper container-fluid">
                <div id="consent-container">
                    <h2>Consentimiento Informado</h2>
                    <div id="consent-text">
                      <p>
                        Yo, <strong id="patient-name">[nombre de la paciente]</strong>, declaro haber sido informada y entender los siguientes puntos respecto a mi estadía en Beauty Recovery Home:
                      </p>
                      <ul>
                        <li>Entiendo que este es un centro de recuperación no médico, donde no se administran medicamentos ni se realizan procedimientos médicos.</li>
                        <li>Me comprometo a seguir las indicaciones postoperatorias dadas por mi cirujano y notificarlas al personal de la casa en caso necesario.</li>
                        <li>El personal está capacitado para brindar apoyo en higiene, alimentación y monitoreo general, pero no sustituye atención médica.</li>
                        <li>Asumo la responsabilidad de comunicar cualquier malestar o síntoma inusual durante mi estadía.</li>
                        <li>Entiendo que los resultados de mi cirugía dependerán del procedimiento realizado y de mi cumplimiento con las indicaciones médicas.</li>
                        <li>Libero a Beauty Recovery Home y su personal de cualquier responsabilidad médica directa relacionada con mi cirugía.</li>
                      </ul>

                      <h4>Condiciones sobre uso del servicio:</h4>
                      <ul>
                        <li>
                          Al realizar el pago y recibir los servicios (alojamiento, alimentos, asistencia u otros), el contrato se considera iniciado y no se realizarán reembolsos por salida anticipada o decisiones personales de la paciente.
                        </li>
                        <li>
                          Una vez que la paciente es trasladada para su procedimiento quirúrgico, se considera que ha recibido el servicio completo correspondiente a su estadía hasta ese momento.
                        </li>
                      </ul>

                      <h4>Confirmación de pago:</h4>
                      <ul>
                        <li>
                          El pago realizado el día de llegada corresponde a los servicios ya brindados. No se reembolsará ninguna cantidad posterior por uso efectivo del servicio, salvo en casos extraordinarios evaluados por la administración.
                        </li>
                      </ul>

                      <p><strong>Firma de la paciente:</strong></p>
                    </div>

                    <div class="sig-box">
                        <canvas id="sigpad"></canvas>
                        <button id="btn-clear" class="btn btn-secondary">Borrar Firma</button>
                        <button id="btn-save" class="btn btn-primary">Firmar y Guardar</button>
                    </div>

                </div>
            </div>
        </div>
        <!-- End section content -->


    </div>

    <!-- JQuery v3.5.1 -->
    <script src="assets/plugins/jquery/jquery.min.js"></script>

    <!-- popper js -->
    <script src="assets/plugins/popper/popper.min.js"></script>

    <!-- Bootstrap -->
    <script src="assets/plugins/bootstrap/js/bootstrap.js"></script>

    <!-- Moment -->
    <script src="assets/plugins/moment/moment.min.js"></script>

    <!-- Date Range Picker -->
    <script src="assets/plugins/daterangepicker/daterangepicker.min.js"></script>

    <!-- Main Custom JQuery -->
    <script src="assets/js/toggleFullScreen.js"></script>
    <script src="assets/js/main.js"></script>
    <script src="assets/js/option-themes.js"></script>
    <script>
      (async () => {
        // Supabase init
        const SUPABASE_URL = 'https://aqkkmgjlcxdbuhwzjeou.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFxa2ttZ2psY3hkYnVod3pqZW91Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU3MjYxNjAsImV4cCI6MjA2MTMwMjE2MH0.kVMtxC6XgrGA8BFwbruCOY5KYv84Phb1M6gi2brojtY';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Get patientId
        const params = new URLSearchParams(window.location.search);
        const patientId = params.get('id');
        if (!patientId) {
          alert('Falta el ID del paciente');
          throw new Error('Missing patientId');
        }

        // Fetch patient’s name and update the consent text
        const { data: patient, error: patErr } = await supabase
          .from('patients')
          .select('first_name, last_name')
          .eq('id', patientId)
          .single();
        if (!patErr && patient) {
          document.getElementById('patient-name').textContent =
            `${patient.first_name} ${patient.last_name}`;
        }

        // Setup SignaturePad...
        const canvas = document.getElementById('sigpad');
        const signaturePad = new SignaturePad(canvas, { backgroundColor: 'rgba(255,255,255,1)' });
        function resizeCanvas() {
          const ratio = window.devicePixelRatio || 1;
          canvas.width = canvas.offsetWidth * ratio;
          canvas.height = canvas.offsetHeight * ratio;
          canvas.getContext('2d').scale(ratio, ratio);
          signaturePad.clear();
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

          document.getElementById('btn-clear').addEventListener('click', () => {
              signaturePad.clear();
          });

        document.getElementById('btn-save').addEventListener('click', async () => {
          if (signaturePad.isEmpty()) {
            return alert('Por favor firme primero');
          }
          // Render consent container to canvas
          const element = document.getElementById('consent-container');
          const canvasElement = await html2canvas(element, { scale: 2 });
          const imgData = canvasElement.toDataURL('image/png');

          // Create PDF with jsPDF (Letter size, 40pt margin, 2-page if needed)
          const { jsPDF } = window.jspdf;
          // create Letter-size PDF with margins
          const pdf = new jsPDF({ unit: 'pt', format: 'letter', orientation: 'portrait' });
          const pageWidth = pdf.internal.pageSize.getWidth();
          const pageHeight = pdf.internal.pageSize.getHeight();
          const margin = 40;
          const usableWidth = pageWidth - margin * 2;

          // get dimensions of rendered image
          const imgProps = pdf.getImageProperties(imgData);
          const imgWidth = usableWidth;
          const imgHeight = (imgProps.height * imgWidth) / imgProps.width;

          // page 1: render top of content
          pdf.addImage(imgData, 'PNG', margin, margin, imgWidth, imgHeight);

          // if content overflows, add second page and render the rest
          if (imgHeight > pageHeight - margin * 2) {
            pdf.addPage();
            // draw shifted upward by one page height minus margins
            pdf.addImage(
              imgData,
              'PNG',
              margin,
              margin - (pageHeight - margin * 2),
              imgWidth,
              imgHeight
            );
          }

          // generate blob and continue upload...
          const pdfBlob = pdf.output('blob');

          // Upload to Supabase Storage
          const filePath = `documents/Consent-${Date.now()}.pdf`;
          const { data: uploadData, error: uploadErr } = await supabase
            .storage
            .from('patient-documents')
            .upload(filePath, pdfBlob, { upsert: true });
          if (uploadErr) {
            console.error('Upload error:', uploadErr);
            return alert('No se pudo subir el PDF de consentimiento.');
          }

          // Insert consent record into patient_documents (allow multiple per patient)
          const { error: insertErr } = await supabase
            .from('patient_documents')
            .insert([
              {
                patient_id: patientId,
                template_key: 'consent',
                file_url: uploadData.path,
                file_type: 'pdf'
              }
            ]);
          if (insertErr) {
            console.error('Insert patient_documents error:', insertErr);
            return alert('No se pudo registrar el documento en la base de datos.');
          }

          alert('Consentimiento guardado correctamente.');
          window.close();
        });
      })();
    </script>

</body>

</html>